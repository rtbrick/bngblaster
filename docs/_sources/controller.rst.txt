.. _controller:

Controller
==========

The BNG Blaster controller provides a REST API to start and stop multiple test instances. 
It exposes the BNG Blaster :ref:`JSON RPC API <api>` as REST API and provides endpoints 
to download logs and reports.

https://github.com/rtbrick/bngblaster-controller

Installation
------------

The BNG Blaster controller should run on any modern Linux distribution
but is primarily tested on Ubuntu 18.04 LTS and Ubuntu 20.04 LTS.

Download and install Debian package: https://github.com/rtbrick/bngblaster-controller/releases

.. code-block:: none

    $ wget https://github.com/rtbrick/bngblaster-controller/releases/download/<version>/bngblaster-controller_<version>_amd64.deb
    $ sudo dpkg -i bngblaster-controller_<version>_amd64.deb


The corresponding service will be started automatically. 

.. code-block:: none

    $ systemctl status rtbrick-bngblasterctrl.service
    ● rtbrick-bngblasterctrl.service - RtBrick BNG Blaster Controller
        Loaded: loaded (/lib/systemd/system/rtbrick-bngblasterctrl.service; enabled; vendor preset: enabled)
        Active: active (running) since Fri 2022-07-01 11:14:01 UTC; 7min ago
    Main PID: 682535 (bngblasterctrl)
        Tasks: 8 (limit: 309235)
        Memory: 2.6M
        CGroup: /system.slice/rtbrick-bngblasterctrl.service
                └─682535 /usr/local/bin/bngblasterctrl


The BNG Blaster controller listens on port `8001` per default, 
which can be changed using the argument `-addr` in the systemd
service unit `/etc/systemd/system/bngblaster-controller.service`. 

.. code-block:: none

    $ sudo bngblasterctrl --help
    Usage of bngblasterctrl:
    -addr string
            HTTP network address (default ":8001")
    -color
            turn on color of color output
    -console
            turn on pretty console logging (default true)
    -d string
            config folder (default "/var/bngblaster")
    -debug
            turn on debug logging
    -e string
            bngblaster executable (default "/usr/sbin/bngblaster")


API
---

OpenAPI: https://rtbrick.github.io/bngblaster-controller/

Create Test Instance
~~~~~~~~~~~~~~~~~~~~

`PUT /api/v1/instances/<instance-name>` 

This API endpoint creates a test instance if not already created. The body of this request 
is stored as bngblaster configuration (`config.json`).

Each test instance creates a directory in `/var/bngblaster/<instance-name>`. 
This directory contains the following files:

* `config.json`: bngblaster configuration
* `run.pid`: bngblaster process ID (if running)
* `run.json`: bngblaster arguments
* `run_report.json`: bngblaster report (if enabled)
* `run.pcap`: bngblaster traffic capture (if enabled)
* `run.sock`: bngblaster control socket
* `run.stderr`: bngblaster standard error
* `run.stdout`: bngblaster standard output 

Start Test 
~~~~~~~~~~~

`POST /api/v1/instances/<instance-name>/_start`

The start API endpoint will start the bngblaster with the argument options
defined in the body.

.. code-block:: json

    {
        "logging": true,
        "logging_flags": [
            "error",
            "ip"
        ]
    }

For creating the result file at the end of the test, please use the attributes result and result_flags:

.. code-block:: json

    {
        "report": true,
        "report_flags": [
            "sessions",
            "streams"
        ]
    }

All supported argument options are explained in the OpenAPI schema.

Status
~~~~~~

`GET /api/v1/instances/<instance-name>`

The status API endpoint returns the status of the test. 

Command 
~~~~~~~

`POST /api/v1/instances/<instance-name>/_command`

The JSON body of this API call will be passed to the bngblaster instance 
control socket (`/var/bngbnlaster/<instance-name>/run.sock`). The result will 
be passed back to the client.

.. code-block:: none

    curl --location --request POST 'http://<IP>>:8001/api/v1/instances/<instance-name>/_command' \
    --header 'Content-Type: application/json' \
    --data-raw '{
        "command": "session-info",
        "arguments": {
            "session-id": 1
        }
    }'


.. code-block:: json

    {
        "status": "ok",
        "code": 200,
        "session-info": {
            "type": "pppoe",
            "session-id": 1,
            "session-state": "Established",
            "...": "..."
        }
    }


The result code is passed as HTTP response status code.

.. code-block:: json

    {
        "status": "warning",
        "code": 404, 
        "message": "session not found"
    }


Stop Test 
~~~~~~~~~

`POST /api/v1/instances/<instance-name>/_stop`

The stop API endpoint will send the SIGINT signal to the corresponding BNG blaster instance (`kill -INT <pid>`).

Delete Test Instance
~~~~~~~~~~~~~~~~~~~~

`DELETE /api/v1/instances/<instance-name>`

This API endpoint deletes the test instance directory. The corresponding
test run is forcefully terminated (`kill -9 <pid>`) if running. 

Metrics
~~~~~~~

`GET /metrics`

This endpoint returns metrics for all instances in Prometheus text format. 

.. code-block:: none

    # HELP instances_running The number of running instances
    # TYPE instances_running gauge
    instances_running{hostname="blaster"} 0
    # HELP instances_total The total number of instances
    # TYPE instances_total gauge
    instances_total{hostname="blaster"} 4

The metric `instances_total` counts the number of test instance directories 
present and `instances_running` shows how many of them are running. 

Every metric is labeled with the hostname where the controller is running.

Per default, there are no metrics per instance. This has to be explicitly 
enabled during instance start (`/api/v1/instances/<instance-name>/_start`) 
using the new  `metric_flags` option.

.. code-block:: json

    {
        "logging": true,
        "logging_flags": [
            "error",
            "ip"
        ],
        "metric_flags": [
            "session_counters",
            "interfaces"
        ]
    }

Currently, the following metrics are supported:

* `session_counters` session statistics
* `interfaces` interface/link counters
* `access_interfaces` access interface function counters
* `network_interfaces` network interface function counters
* `a10nsp_interfaces` a10nsp interface function counters
* `streams` stream counters

The `streams` metric generates statistics for every stream and direction.
Therefore the `streams` metric should not be used with massive streams 
(e.g. > 10.000 streams) but there is no limit enforced. 

.. code-block:: none

    # HELP sessions The total number of sessions
    # TYPE sessions counter
    sessions{hostname="blaster",instance_name="test"} 10
    # HELP sessions_established The number of sessions in the state established
    # TYPE sessions_established gauge
    sessions_established{hostname="blaster",instance_name="test"} 10
    ...

Instance metrics are labeled with the instance name. All interface-specific metrics
are also labeled with the corresponding interface name and type. 

.. code-block:: none

    # HELP interfaces_rx_packets Interface RX packets
    # TYPE interfaces_rx_packets counter
    interfaces_rx_packets{hostname="rbfs",instance_name="test",interface_name="eth1",interface_type="Interface"} 163
    interfaces_rx_packets{hostname="rbfs",instance_name="test",interface_name="eth11",interface_type="Network"} 155
    interfaces_rx_packets{hostname="rbfs",instance_name="test",interface_name="eth12",interface_type="Interface"} 158
    interfaces_rx_packets{hostname="rbfs",instance_name="test",interface_name="eth12",interface_type="Access"} 150
    ...
    

Results
~~~~~~~

`GET /api/v1/instances/<instance-name>/run_report.json`

The result data structure can be retrieved with this request. Given the gets pppoe example the result looks like this:

.. code-block:: json

    {
        "report": {
            "a10nsp-interfaces": [
                {
                    "name": "veth1.1",
                    "rx-packets": 37,
                    "rx-session-packets-ipv4": 11,
                    "rx-session-packets-ipv4-avg-pps-max": 1,
                    "rx-session-packets-ipv4-loss": 0,
                    "rx-session-packets-ipv6": 0,
                    "rx-session-packets-ipv6-avg-pps-max": 0,
                    "rx-session-packets-ipv6-loss": 0,
                    "rx-session-packets-ipv6pd": 0,
                    "rx-session-packets-ipv6pd-avg-pps-max": 0,
                    "rx-session-packets-ipv6pd-loss": 0,
                    "rx-stream-packets": 22,
                    "rx-stream-packets-loss": 0,
                    "tx-packets": 34,
                    "tx-session-packets-ipv4": 11,
                    "tx-session-packets-ipv4-avg-pps-max": 1,
                    "tx-session-packets-ipv6": 0,
                    "tx-session-packets-ipv6-avg-pps-max": 0,
                    "tx-session-packets-ipv6pd": 0,
                    "tx-session-packets-ipv6pd-avg-pps-max": 0,
                    "tx-stream-packets": 22
                }
            ],
            "access-interfaces": [
                {
                    "name": "veth1.2",
                    "protocol-stats": {
                        "chap-timeout": 0,
                        "dhcp-timeout": 0,
                        "dhcpv6-timeout": 0,
                        "icmpv6-rs-timeout": 0,
                        "ip6cp-request-timeout": 0,
                        "ipcp-request-timeout": 0,
                        "lcp-echo-timeout": 0,
                        "lcp-request-timeout": 0,
                        "pap-timeout": 0,
                        "rx-arp": 0,
                        "rx-chap": 0,
                        "rx-dhcp": 0,
                        "rx-dhcpv6": 0,
                        "rx-icmp": 0,
                        "rx-icmpv6": 0,
                        "rx-igmp": 0,
                        "rx-ip6cp": 2,
                        "rx-ipcp": 4,
                        "rx-ipv4-fragmented": 0,
                        "rx-lcp": 3,
                        "rx-pado": 1,
                        "rx-pads": 1,
                        "rx-padt": 0,
                        "rx-pap": 1,
                        "tx-arp": 0,
                        "tx-chap": 0,
                        "tx-dhcp": 0,
                        "tx-dhcpv6": 0,
                        "tx-icmp": 0,
                        "tx-icmpv6": 3,
                        "tx-igmp": 0,
                        "tx-ip6cp": 2,
                        "tx-ipcp": 4,
                        "tx-lcp": 3,
                        "tx-padi": 1,
                        "tx-padr": 1,
                        "tx-padt": 1,
                        "tx-pap": 1
                    },
                    "rx-multicast-packets": 0,
                    "rx-multicast-packets-loss": 0,
                    "rx-packets": 34,
                    "rx-session-packets-ipv4": 11,
                    "rx-session-packets-ipv4-avg-pps-max": 1,
                    "rx-session-packets-ipv4-loss": 0,
                    "rx-session-packets-ipv4-wrong-session": 0,
                    "rx-session-packets-ipv6": 0,
                    "rx-session-packets-ipv6-loss": 0,
                    "rx-session-packets-ipv6-wrong-session": 0,
                    "rx-session-packets-ipv6avg-pps-max": 0,
                    "rx-session-packets-ipv6pd": 0,
                    "rx-session-packets-ipv6pd-avg-pps-max": 0,
                    "rx-session-packets-ipv6pd-loss": 0,
                    "rx-session-packets-ipv6pd-wrong-session": 0,
                    "rx-stream-packets": 22,
                    "rx-stream-packets-loss": 0,
                    "tx-packets": 38,
                    "tx-session-packets-ipv4": 11,
                    "tx-session-packets-ipv4-avg-pps-max": 1,
                    "tx-session-packets-ipv6": 0,
                    "tx-session-packets-ipv6-avg-pps-max": 0,
                    "tx-session-packets-ipv6pd": 0,
                    "tx-session-packets-ipv6pd-avg-pps-max": 0,
                    "tx-stream-packets": 22
                }
            ],
            "dhcp-sessions-established": 0,
            "dhcpv6-sessions-established": 0,
            "interfaces": [
                {
                    "name": "veth1.1",
                    "rx-bytes": 4943,
                    "rx-io-error": 0,
                    "rx-packets": 37,
                    "rx-polled": 4943,
                    "rx-protocol-error": 0,
                    "rx-unknown": 0,
                    "tx-bytes": 4879,
                    "tx-io-error": 0,
                    "tx-packets": 34,
                    "tx-polled": 0,
                    "type": "Interface"
                },
                {
                    "name": "veth1.2",
                    "rx-bytes": 4743,
                    "rx-io-error": 0,
                    "rx-packets": 34,
                    "rx-polled": 4743,
                    "rx-protocol-error": 0,
                    "rx-unknown": 0,
                    "tx-bytes": 5119,
                    "tx-io-error": 0,
                    "tx-packets": 38,
                    "tx-polled": 0,
                    "type": "Interface"
                }
            ],
            "session-traffic": {
                "config-ipv4-pps": 1,
                "config-ipv6-pps": 0,
                "config-ipv6pd-pps": 0,
                "first-seq-rx-downstream-ipv4-avg": 1,
                "first-seq-rx-downstream-ipv4-avg-seconds": 1.0,
                "first-seq-rx-downstream-ipv4-max": 1,
                "first-seq-rx-downstream-ipv4-max-seconds": 1.0,
                "first-seq-rx-downstream-ipv4-min": 1,
                "first-seq-rx-downstream-ipv4-min-seconds": 1.0,
                "first-seq-rx-downstream-ipv6-avg": 0,
                "first-seq-rx-downstream-ipv6-avg-seconds": 0.0,
                "first-seq-rx-downstream-ipv6-max": 0,
                "first-seq-rx-downstream-ipv6-max-seconds": 0.0,
                "first-seq-rx-downstream-ipv6-min": 0,
                "first-seq-rx-downstream-ipv6-min-seconds": 0.0,
                "first-seq-rx-downstream-ipv6pd-avg": 0,
                "first-seq-rx-downstream-ipv6pd-avg-seconds": 0.0,
                "first-seq-rx-downstream-ipv6pd-max": 0,
                "first-seq-rx-downstream-ipv6pd-max-seconds": 0.0,
                "first-seq-rx-downstream-ipv6pd-min": 0,
                "first-seq-rx-downstream-ipv6pd-min-seconds": 0.0,
                "first-seq-rx-upstream-ipv4-avg": 1,
                "first-seq-rx-upstream-ipv4-avg-seconds": 1.0,
                "first-seq-rx-upstream-ipv4-max": 1,
                "first-seq-rx-upstream-ipv4-max-seconds": 1.0,
                "first-seq-rx-upstream-ipv4-min": 1,
                "first-seq-rx-upstream-ipv4-min-seconds": 1.0,
                "first-seq-rx-upstream-ipv6-avg": 0,
                "first-seq-rx-upstream-ipv6-avg-seconds": 0.0,
                "first-seq-rx-upstream-ipv6-max": 0,
                "first-seq-rx-upstream-ipv6-max-seconds": 0.0,
                "first-seq-rx-upstream-ipv6-min": 0,
                "first-seq-rx-upstream-ipv6-min-seconds": 0.0,
                "first-seq-rx-upstream-ipv6pd-avg": 0,
                "first-seq-rx-upstream-ipv6pd-avg-seconds": 0.0,
                "first-seq-rx-upstream-ipv6pd-max": 0,
                "first-seq-rx-upstream-ipv6pd-max-seconds": 0.0,
                "first-seq-rx-upstream-ipv6pd-min": 0,
                "first-seq-rx-upstream-ipv6pd-min-seconds": 0.0,
                "total-flows": 2,
                "verified-flows": 2,
                "verified-flows-downstream-ipv4": 1,
                "verified-flows-downstream-ipv6": 0,
                "verified-flows-downstream-ipv6pd": 0,
                "verified-flows-upstream-ipv4": 1,
                "verified-flows-upstream-ipv6": 0,
                "verified-flows-upstream-ipv6pd": 0,
                "violated-flows-downstream-ipv4-1s": 0,
                "violated-flows-downstream-ipv4-2s": 0,
                "violated-flows-downstream-ipv4-3s": 0,
                "violated-flows-downstream-ipv6-1s": 0,
                "violated-flows-downstream-ipv6-2s": 0,
                "violated-flows-downstream-ipv6-3s": 0,
                "violated-flows-downstream-ipv6pd-1s": 0,
                "violated-flows-downstream-ipv6pd-2s": 0,
                "violated-flows-downstream-ipv6pd-3s": 0,
                "violated-flows-upstream-ipv4-1s": 0,
                "violated-flows-upstream-ipv4-2s": 0,
                "violated-flows-upstream-ipv4-3s": 0,
                "violated-flows-upstream-ipv6-1s": 0,
                "violated-flows-upstream-ipv6-2s": 0,
                "violated-flows-upstream-ipv6-3s": 0,
                "violated-flows-upstream-ipv6pd-1s": 0,
                "violated-flows-upstream-ipv6pd-2s": 0,
                "violated-flows-upstream-ipv6pd-3s": 0
            },
            "sessions": [
                {
                    "dhcpv6-state": "Disabled",
                    "inner-vlan": 7,
                    "interface": "veth1.2",
                    "ip6cp-state": "Closed",
                    "ipcp-state": "Closed",
                    "ipv4-address": "10.10.10.10",
                    "ipv4-dns1": "10.12.12.10",
                    "ipv4-dns2": "10.13.13.10",
                    "lcp-state": "Closed",
                    "mac": "02:00:00:00:00:01",
                    "outer-vlan": 1,
                    "reply-message": "BNG-Blaster-A10NSP",
                    "rx-fragmented-packets": 0,
                    "rx-packets": 34,
                    "session-id": 1,
                    "session-state": "Terminated",
                    "session-traffic": {
                        "downstream-ipv4-flow-id": 2,
                        "downstream-ipv4-loss": 0,
                        "downstream-ipv4-rx-first-seq": 1,
                        "downstream-ipv4-rx-packets": 11,
                        "downstream-ipv4-tx-packets": 11,
                        "downstream-ipv4-wrong-session": 0,
                        "total-flows": 2,
                        "upstream-ipv4-flow-id": 1,
                        "upstream-ipv4-loss": 0,
                        "upstream-ipv4-rx-first-seq": 1,
                        "upstream-ipv4-rx-packets": 11,
                        "upstream-ipv4-tx-packets": 11,
                        "upstream-ipv4-wrong-session": 0,
                        "verified-flows": 2
                    },
                    "tx-packets": 38,
                    "type": "pppoe",
                    "username": "user1@rtbrick.com"
                }
            ],
            "sessions-established": 1,
            "sessions-flapped": 0,
            "sessions-ipoe": 0,
            "sessions-pppoe": 1,
            "setup-rate-cps": 125.0,
            "setup-rate-cps-avg": 125.0,
            "setup-rate-cps-max": 125.0,
            "setup-rate-cps-min": 125.0,
            "setup-time-ms": 8,
            "streams": [
                {
                    "a10nsp-interface": "veth1.1",
                    "direction": "downstream",
                    "flow-id": 4,
                    "name": "S1",
                    "rx-bps-l2": 2256,
                    "rx-bps-l3": 2048,
                    "rx-bytes": 3102,
                    "rx-delay-us-max": 1,
                    "rx-delay-us-min": 1,
                    "rx-first-seq": 1,
                    "rx-inner-vlan-pbit": 0,
                    "rx-last-seq": 11,
                    "rx-len": 282,
                    "rx-loss": 0,
                    "rx-mbps-l2": 0.002256,
                    "rx-mbps-l3": 0.002048,
                    "rx-outer-vlan-pbit": 0,
                    "rx-packets": 11,
                    "rx-pps": 1,
                    "rx-tos-tc": 128,
                    "rx-wrong-session": 0,
                    "session-id": 1,
                    "session-traffic": false,
                    "sub-type": "ipv4",
                    "tx-bps-l2": 2288,
                    "tx-bytes": 3146,
                    "tx-len": 286,
                    "tx-mbps-l2": 0.002288,
                    "tx-packets": 11,
                    "tx-pps": 1,
                    "type": "unicast",
                    "verified": true
                },
                {
                    "access-interface": "veth1.2",
                    "direction": "upstream",
                    "flow-id": 1,
                    "name": "session-ipv4",
                    "rx-bps-l2": 816,
                    "rx-bps-l3": 0,
                    "rx-bytes": 1122,
                    "rx-delay-us-max": 1270,
                    "rx-delay-us-min": 1255,
                    "rx-first-seq": 1,
                    "rx-inner-vlan-pbit": 0,
                    "rx-last-seq": 11,
                    "rx-len": 102,
                    "rx-loss": 0,
                    "rx-mbps-l2": 0.000816,
                    "rx-mbps-l3": 0.0,
                    "rx-outer-vlan-pbit": 0,
                    "rx-packets": 11,
                    "rx-pps": 1,
                    "rx-tos-tc": 0,
                    "rx-wrong-session": 0,
                    "session-id": 1,
                    "session-traffic": true,
                    "sub-type": "ipv4",
                    "tx-bps-l2": 848,
                    "tx-bytes": 1166,
                    "tx-len": 106,
                    "tx-mbps-l2": 0.000848,
                    "tx-packets": 11,
                    "tx-pps": 1,
                    "type": "unicast",
                    "verified": true
                },
                {
                    "access-interface": "veth1.2",
                    "direction": "upstream",
                    "flow-id": 3,
                    "name": "S1",
                    "rx-bps-l2": 2256,
                    "rx-bps-l3": 2048,
                    "rx-bytes": 3102,
                    "rx-delay-us-max": 1554,
                    "rx-delay-us-min": 1168,
                    "rx-first-seq": 1,
                    "rx-inner-vlan-pbit": 0,
                    "rx-last-seq": 11,
                    "rx-len": 282,
                    "rx-loss": 0,
                    "rx-mbps-l2": 0.002256,
                    "rx-mbps-l3": 0.002048,
                    "rx-outer-vlan-pbit": 0,
                    "rx-packets": 11,
                    "rx-pps": 1,
                    "rx-tos-tc": 128,
                    "rx-wrong-session": 0,
                    "session-id": 1,
                    "session-traffic": false,
                    "sub-type": "ipv4",
                    "tx-bps-l2": 2288,
                    "tx-bytes": 3146,
                    "tx-len": 286,
                    "tx-mbps-l2": 0.002288,
                    "tx-packets": 11,
                    "tx-pps": 1,
                    "type": "unicast",
                    "verified": true
                },
                {
                    "a10nsp-interface": "veth1.1",
                    "direction": "downstream",
                    "flow-id": 2,
                    "name": "session-ipv4",
                    "rx-bps-l2": 816,
                    "rx-bps-l3": 0,
                    "rx-bytes": 1122,
                    "rx-delay-us-max": 1,
                    "rx-delay-us-min": 1,
                    "rx-first-seq": 1,
                    "rx-inner-vlan-pbit": 0,
                    "rx-last-seq": 11,
                    "rx-len": 102,
                    "rx-loss": 0,
                    "rx-mbps-l2": 0.000816,
                    "rx-mbps-l3": 0.0,
                    "rx-outer-vlan-pbit": 0,
                    "rx-packets": 11,
                    "rx-pps": 1,
                    "rx-tos-tc": 0,
                    "rx-wrong-session": 0,
                    "session-id": 1,
                    "session-traffic": true,
                    "sub-type": "ipv4",
                    "tx-bps-l2": 848,
                    "tx-bytes": 1166,
                    "tx-len": 106,
                    "tx-mbps-l2": 0.000848,
                    "tx-packets": 11,
                    "tx-pps": 1,
                    "type": "unicast",
                    "verified": true
                }
            ],
            "traffic-streams": {
                "first-seq-rx-max": 1,
                "first-seq-rx-min": 1,
                "flow-rx-delay-us-max": 1554,
                "flow-rx-delay-us-min": 1,
                "flow-rx-packet-loss-max": 0,
                "flow-rx-packet-loss-min": 0,
                "total-flows": 2,
                "verified-flows": 2
            }
        }
    }

